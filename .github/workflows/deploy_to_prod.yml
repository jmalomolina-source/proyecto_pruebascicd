# Archivo: .github/workflows/deploy_to_prod.yml

name: Despliegue a Carpeta Local PRO

# 1. Configuración de Disparador (Trigger)
# Se ejecuta cuando se fusiona cualquier Pull Request A la rama 'master' (o 'main')
on:
  push:
    branches:
      - main
      # Si usas 'main' en lugar de 'master', cambia la línea anterior a: - main
  workflow_dispatch: # Permite ejecución manual desde GitHub

# 2. Definición del Trabajo (Job) de Despliegue
jobs:
  deploy:
    # Usaremos un runner de Windows, ya que tu ruta de destino es de Windows (C:\)
    # En producción real, usarías un runner personalizado o SSH para el servidor PRO.
    runs-on: windows-latest 
    environment: produccion # Opcional: Para usar Secretos/Variables de entorno específicos de PRO

    steps:
      # Paso 1: Descargar el código
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      # Paso 2: Configurar el ambiente Python
      - name: Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      # Paso 3: Instalar las dependencias de la rama master
      - name: Instalar dependencias
        run: pip install -r requirements.txt
        shell: powershell

      # Paso 4: Despliegue a Servidor Remoto (Tu PC)
      - name: Despliegue Remoto con Transferencia SCP
        # Usamos una acción enfocada en SCP que funciona en Windows
        uses: appleboy/scp-action@master 
        with:
          # --- Credenciales Seguras (Guardadas como Secrets de GitHub) ---
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22                             # El puerto SSH
          
          # --- Configuración de Transferencia de Archivos ---
          # La acción SCP usa 'source' y 'target' directamente:
          source: "." # La raíz del repositorio descargado
          target: "C:/jmalo/FUENTES/GITHUB/fuentes/pro/ejecutable/" 
          # Importante: Usa barras inclinadas (/) en la ruta de Windows para SCP/Git
          
      # Paso 5: Opcional - Ejecutar Comando Remoto Post-Despliegue
      - name: Reiniciar Servicio ETL (Comando Remoto)
        uses: appleboy/ssh-action@v1.0.3 # Usamos el SSH-Action solo para ejecutar comandos
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Aquí puedes poner comandos de Windows (CMD) o PowerShell
            # Por ejemplo: Detener y reiniciar el servicio ETL
            Stop-Service -Name "TuNombreDeServicioETL"
            Start-Service -Name "TuNombreDeServicioETL"
        shell: powershell